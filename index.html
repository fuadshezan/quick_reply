<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>‚ö° Quick Replies & Images</title>

  <!-- Fonts -->
  <link
    href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:wght@400;600;700;800&family=Instrument+Sans:wght@400;500;600&display=swap"
    rel="stylesheet" />

  <style>
    :root {
      --bg-main: #0A0E27;
      --bg-card: #151932;
      --bg-search: #1D2342;
      --accent: #00D9FF;
      --accent-glow: rgba(0, 217, 255, 0.15);
      --text-primary: #F8F9FC;
      --text-muted: #8B92B2;
      --border: rgba(139, 146, 178, 0.12);
      --success: #00FF94;
      --warning: #FFB800;
      --radius: 16px;
      --shadow: 0 4px 24px rgba(0, 0, 0, 0.4);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    html {
      font-size: 16px;
    }

    body {
      font-family: 'Instrument Sans', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-main);
      color: var(--text-primary);
      min-height: 100dvh;
      overflow-x: hidden;
      line-height: 1.5;
    }

    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background:
        radial-gradient(circle at 20% 20%, rgba(0, 217, 255, 0.08) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(0, 255, 148, 0.06) 0%, transparent 50%);
      animation: gradientShift 15s ease infinite;
      z-index: 0;
      pointer-events: none;
    }

    @keyframes gradientShift {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.7;
      }
    }

    .header {
      position: sticky;
      top: 0;
      z-index: 100;
      background: rgba(10, 14, 39, 0.95);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border);
      padding: 16px 20px 0;
    }

    .header-top {
      max-width: 800px;
      margin: 0 auto 12px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo {
      font-family: 'Bricolage Grotesque', sans-serif;
      font-size: 24px;
      font-weight: 800;
      background: linear-gradient(135deg, var(--accent) 0%, var(--success) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      display: flex;
      align-items: center;
      gap: 8px;
      letter-spacing: -0.02em;
    }

    .logo::before {
      content: '‚ö°';
      font-size: 28px;
      filter: drop-shadow(0 0 8px var(--accent));
      -webkit-text-fill-color: var(--accent);
    }

    .header-actions {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .settings-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 1px solid var(--border);
      background: var(--bg-card);
      color: var(--text-muted);
      font-size: 18px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .settings-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
      background: var(--accent-glow);
    }

    .sync-status {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      color: var(--text-muted);
      font-weight: 500;
    }

    .sync-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success);
      animation: pulse 2s ease infinite;
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1;
        box-shadow: 0 0 0 0 var(--success);
      }

      50% {
        opacity: 0.7;
        box-shadow: 0 0 0 4px transparent;
      }
    }

    .tabs {
      max-width: 800px;
      margin: 0 auto;
      display: flex;
      gap: 4px;
    }

    .tab {
      flex: 1;
      padding: 12px 16px;
      border: none;
      background: transparent;
      color: var(--text-muted);
      font-family: 'Bricolage Grotesque', sans-serif;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      border-bottom: 3px solid transparent;
    }

    .tab:hover {
      color: var(--text-primary);
    }

    .tab.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
    }

    .search-container {
      max-width: 800px;
      margin: 24px auto;
      padding: 0 20px;
      position: relative;
      z-index: 10;
    }

    .search-wrapper {
      position: relative;
      display: flex;
      gap: 12px;
    }

    .search-box {
      flex: 1;
      position: relative;
    }

    .search-input {
      width: 100%;
      background: var(--bg-search);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px 20px 16px 52px;
      font-size: 16px;
      font-family: inherit;
      color: var(--text-primary);
      outline: none;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      font-weight: 500;
    }

    .search-input::placeholder {
      color: var(--text-muted);
    }

    .search-input:focus {
      border-color: var(--accent);
      background: var(--bg-card);
      box-shadow: 0 0 0 3px var(--accent-glow);
    }

    .search-icon {
      position: absolute;
      left: 20px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 20px;
      color: var(--text-muted);
      pointer-events: none;
    }

    .reload-btn {
      width: 56px;
      height: 56px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: var(--bg-card);
      color: var(--accent);
      font-size: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .reload-btn:hover {
      border-color: var(--accent);
      background: var(--accent-glow);
      transform: rotate(180deg);
    }

    .reload-btn:active {
      transform: rotate(180deg) scale(0.95);
    }

    .categories {
      max-width: 800px;
      margin: 0 auto 24px;
      padding: 0 20px;
      display: flex;
      gap: 10px;
      overflow-x: auto;
      scrollbar-width: none;
      -webkit-overflow-scrolling: touch;
    }

    .categories::-webkit-scrollbar {
      display: none;
    }

    .category-chip {
      white-space: nowrap;
      padding: 10px 20px;
      border-radius: 100px;
      font-size: 14px;
      font-weight: 600;
      border: 1px solid var(--border);
      background: var(--bg-card);
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      flex-shrink: 0;
    }

    .category-chip:hover {
      border-color: var(--accent);
      color: var(--text-primary);
    }

    .category-chip.active {
      background: var(--accent);
      border-color: var(--accent);
      color: var(--bg-main);
      font-weight: 700;
      box-shadow: 0 4px 12px var(--accent-glow);
    }

    .content {
      max-width: 800px;
      margin: 0 auto;
      padding: 0 20px 40px;
      position: relative;
      z-index: 10;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    #replies-tab.replies-grid.active {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
      align-items: start;
    }

    .reply-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 14px;
      margin-bottom: 0;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      /* overflow: hidden; */
      overflow: visible;
    }

    .reply-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 4px;
      height: 100%;
      background: linear-gradient(180deg, var(--accent), var(--success));
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .reply-card:hover {
      border-color: var(--accent);
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    .reply-card:hover::before {
      opacity: 1;
    }

    .reply-card:active {
      transform: translateY(0) scale(0.98);
    }

    .reply-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 5px;
      /* margin-bottom: -5px; */
    }

    .reply-title {
      font-family: 'Bricolage Grotesque', sans-serif;
      font-size: 14px;
      font-weight: 700;
      color: var(--text-primary);
      line-height: 1.3;
    }

    .copy-indicator {
      font-size: 20px;
      opacity: 0;
      color: var(--success);
      transition: all 0.3s ease;
    }

    .reply-card:hover .copy-indicator {
      opacity: 0.5;
    }

    .reply-main {
      display: grid;
      grid-template-columns: minmax(0, 1fr) 120px;
      gap: 12px;
      align-items: start;
    }

    .reply-card.no-image .reply-main {
      grid-template-columns: 1fr;
    }

    .reply-content {
      min-width: 0;
    }

    .reply-body {
      color: var(--text-muted);
      font-size: 10px;
      line-height: 1.5;
      margin-bottom: 5px;
      white-space: pre-wrap;
      word-wrap: break-word;
      overflow-wrap: break-word;
      max-width: 100%;
    }

    .reply-image-wrap {
      width: 120px;
      align-self: start;
    }

    .reply-image-preview {
      width: 100%;
      max-width: none;
      aspect-ratio: 1 / 1;
      object-fit: cover;
      border-radius: 12px;
      margin-bottom: 0;
      border: 1px solid var(--border);
    }

    .reply-footer {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .category-tag {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 12px;
      border-radius: 100px;
      font-size: 12px;
      font-weight: 600;
      background: var(--accent-glow);
      color: var(--accent);
      border: 1px solid rgba(0, 217, 255, 0.2);
    }

    @media (max-width: 720px) {
      #replies-tab.replies-grid.active {
        grid-template-columns: 1fr;
      }

      .reply-main {
        grid-template-columns: 1fr;
      }

      .reply-image-wrap {
        width: min(100%, 160px);
      }
    }

    .product-folder {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 20px;
    }

    .product-folder-header {
      font-family: 'Bricolage Grotesque', sans-serif;
      font-size: 20px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .product-folder-header::before {
      content: 'üìÅ';
      font-size: 24px;
    }

    .images-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 12px;
    }

    .image-item {
      position: relative;
      aspect-ratio: 1;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid var(--border);
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .image-item:hover {
      transform: scale(1.05);
      box-shadow: var(--shadow);
      border-color: var(--accent);
    }

    .image-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .lightbox {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.95);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .lightbox.show {
      display: flex;
    }

    .lightbox-content {
      max-width: 90%;
      max-height: 90%;
      position: relative;
    }

    .lightbox-image {
      max-width: 100%;
      max-height: 90vh;
      border-radius: 12px;
    }

    .lightbox-close {
      position: absolute;
      top: -40px;
      right: 0;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--bg-card);
      border: 1px solid var(--border);
      color: var(--text-primary);
      font-size: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .loading,
    .empty-state {
      text-align: center;
      padding: 80px 20px;
      color: var(--text-muted);
    }

    .loading-spinner {
      font-size: 48px;
      animation: spin 2s linear infinite;
      display: inline-block;
      margin-bottom: 16px;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .empty-icon {
      font-size: 64px;
      opacity: 0.3;
      margin-bottom: 16px;
    }

    .empty-title {
      font-family: 'Bricolage Grotesque', sans-serif;
      font-size: 20px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--bg-card);
      color: var(--text-primary);
      padding: 16px 24px;
      border-radius: 100px;
      font-weight: 600;
      font-size: 15px;
      box-shadow: var(--shadow);
      border: 1px solid var(--accent);
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      backdrop-filter: blur(20px);
    }

    .toast.show {
      transform: translateX(-50%) translateY(0);
    }

    .toast-icon {
      font-size: 20px;
      color: var(--success);
    }

    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(8px);
      z-index: 200;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal-overlay.show {
      display: flex;
    }

    .modal {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 24px;
      max-width: 500px;
      width: 100%;
      padding: 32px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
      animation: modalIn 0.3s ease;
      max-height: 90vh;
      overflow-y: auto;
    }

    @keyframes modalIn {
      from {
        opacity: 0;
        transform: scale(0.95);
      }

      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    .modal-title {
      font-family: 'Bricolage Grotesque', sans-serif;
      font-size: 24px;
      font-weight: 800;
      margin-bottom: 8px;
      color: var(--text-primary);
    }

    .modal-desc {
      color: var(--text-muted);
      margin-bottom: 24px;
      line-height: 1.6;
      font-size: 14px;
    }

    .modal-label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text-primary);
      font-size: 14px;
    }

    .modal-input,
    .modal-textarea {
      width: 100%;
      background: var(--bg-search);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px 16px;
      font-size: 14px;
      font-family: 'Courier New', monospace;
      color: var(--text-primary);
      outline: none;
      transition: all 0.3s ease;
      margin-bottom: 20px;
    }

    .modal-textarea {
      resize: vertical;
      min-height: 100px;
      line-height: 1.4;
    }

    .modal-input:focus,
    .modal-textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-glow);
    }

    .modal-btn {
      width: 100%;
      background: linear-gradient(135deg, var(--accent), var(--success));
      border: none;
      border-radius: 12px;
      padding: 16px;
      font-size: 16px;
      font-weight: 700;
      font-family: 'Bricolage Grotesque', sans-serif;
      color: var(--bg-main);
      cursor: pointer;
      transition: all 0.3s ease;
      margin-bottom: 12px;
    }

    .modal-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px var(--accent-glow);
    }

    .modal-btn:active {
      transform: translateY(0);
    }

    .modal-btn-secondary {
      background: var(--bg-search);
      color: var(--text-muted);
    }

    .modal-btn-secondary:hover {
      background: var(--border);
      color: var(--text-primary);
      box-shadow: none;
    }

    .current-config {
      background: var(--bg-search);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px 16px;
      margin-bottom: 20px;
      font-size: 13px;
      color: var(--text-muted);
      word-break: break-all;
    }

    .config-label {
      font-weight: 600;
      color: var(--accent);
      display: block;
      margin-bottom: 4px;
    }
  </style>
</head>

<body>

  <header class="header">
    <div class="header-top">
      <div class="logo">Quick Replies</div>
      <div class="header-actions">
        <div class="sync-status">
          <span class="sync-dot"></span>
          <span id="sync-text">Live</span>
        </div>
        <button class="settings-btn" onclick="openSettings()" title="Settings">
          ‚öôÔ∏è
        </button>
      </div>
    </div>
    <div class="tabs">
      <button class="tab active" onclick="switchTab('replies')">üí¨ Replies</button>
      <button class="tab" onclick="switchTab('images')">üñºÔ∏è Images</button>
    </div>
  </header>

  <div class="search-container">
    <div class="search-wrapper">
      <div class="search-box">
        <span class="search-icon">üîç</span>
        <input type="text" class="search-input" id="search-input" placeholder="Search..." autocomplete="off" />
      </div>
      <button class="reload-btn" id="reload-btn" title="Reload">
        üîÑ
      </button>
    </div>
  </div>

  <div class="categories" id="categories">
    <div class="category-chip active" data-category="">All</div>
  </div>

  <div class="content">
    <div class="tab-content active" id="replies-tab"></div>
    <div class="tab-content" id="images-tab"></div>
  </div>

  <div class="toast" id="toast">
    <span class="toast-icon">‚úì</span>
    <span id="toast-text">Copied!</span>
  </div>

  <div class="lightbox" id="lightbox" onclick="closeLightbox()">
    <div class="lightbox-content" onclick="event.stopPropagation()">
      <button class="lightbox-close" onclick="closeLightbox()">√ó</button>
      <img id="lightbox-image" class="lightbox-image" src="" alt="Full size" />
    </div>
  </div>

  <!-- Settings Modal -->
  <div class="modal-overlay" id="settings-modal">
    <div class="modal">
      <h2 class="modal-title">‚öôÔ∏è Settings</h2>
      <p class="modal-desc">Set separate Google Sheets sources for Saved Replies and Image Gallery. Use either a Sheet
        ID or full published CSV URL for each.</p>

      <div class="current-config" id="current-config-display">
        <span class="config-label">Current Replies Source:</span>
        <span id="current-replies-config-value">Not configured</span>
        <span class="config-label" style="margin-top: 10px;">Current Images Source:</span>
        <span id="current-images-config-value">Not configured</span>
      </div>

      <label class="modal-label">Saved Replies Sheet URL or ID</label>
      <textarea class="modal-textarea" id="sheets-replies-config-input" placeholder="Paste either:
- Full URL: https://docs.google.com/spreadsheets/d/e/2PACX-.../pub?...
- Sheet ID: 1A2B3C4D5E..."></textarea>

      <label class="modal-label">Image Gallery Sheet URL or ID</label>
      <textarea class="modal-textarea" id="sheets-images-config-input" placeholder="Paste either:
- Full URL: https://docs.google.com/spreadsheets/d/e/2PACX-.../pub?...
- Sheet ID: 1A2B3C4D5E..."></textarea>

      <button class="modal-btn" onclick="saveConfig()">Save & Reload</button>
      <button class="modal-btn modal-btn-secondary" onclick="closeSettings()">Cancel</button>
    </div>
  </div>

  <script>
    const LEGACY_SHEETS_CONFIG = localStorage.getItem('SHEETS_CONFIG') || '';
    let REPLIES_SHEETS_CONFIG = localStorage.getItem('REPLIES_SHEETS_CONFIG') || LEGACY_SHEETS_CONFIG;
    let IMAGES_SHEETS_CONFIG = localStorage.getItem('IMAGES_SHEETS_CONFIG') || LEGACY_SHEETS_CONFIG;
    let allReplies = [];
    let allProducts = {};
    let filteredReplies = [];
    let activeCategory = '';
    let activeTab = 'replies';

    document.addEventListener('DOMContentLoaded', () => {
      if (!REPLIES_SHEETS_CONFIG || !IMAGES_SHEETS_CONFIG) {
        openSettings();
      } else {
        loadData();
      }

      document.getElementById('search-input').addEventListener('input', handleSearch);
      document.getElementById('reload-btn').addEventListener('click', loadData);
    });

    function openSettings() {
      document.getElementById('settings-modal').classList.add('show');
      document.getElementById('sheets-replies-config-input').value = REPLIES_SHEETS_CONFIG;
      document.getElementById('sheets-images-config-input').value = IMAGES_SHEETS_CONFIG;

      const repliesDisplay = REPLIES_SHEETS_CONFIG
        ? (REPLIES_SHEETS_CONFIG.length > 60 ? REPLIES_SHEETS_CONFIG.substring(0, 60) + '...' : REPLIES_SHEETS_CONFIG)
        : 'Not configured';
      const imagesDisplay = IMAGES_SHEETS_CONFIG
        ? (IMAGES_SHEETS_CONFIG.length > 60 ? IMAGES_SHEETS_CONFIG.substring(0, 60) + '...' : IMAGES_SHEETS_CONFIG)
        : 'Not configured';

      document.getElementById('current-replies-config-value').textContent = repliesDisplay;
      document.getElementById('current-images-config-value').textContent = imagesDisplay;
    }

    function closeSettings() {
      document.getElementById('settings-modal').classList.remove('show');
    }

    function saveConfig() {
      const repliesInput = document.getElementById('sheets-replies-config-input').value.trim();
      const imagesInput = document.getElementById('sheets-images-config-input').value.trim();

      if (!repliesInput || !imagesInput) {
        alert('Please enter both Saved Replies and Image Gallery sheet URL/ID');
        return;
      }

      REPLIES_SHEETS_CONFIG = repliesInput;
      IMAGES_SHEETS_CONFIG = imagesInput;
      localStorage.setItem('REPLIES_SHEETS_CONFIG', repliesInput);
      localStorage.setItem('IMAGES_SHEETS_CONFIG', imagesInput);

      closeSettings();
      loadData();
    }

    function buildSheetUrl(configValue, sheetName) {
      const config = (configValue || '').trim();
      if (!config) return '';

      if (config.includes('docs.google.com')) {
        if (config.includes('output=csv')) {
          return config;
        }

        const idMatch = config.match(/\/d\/([a-zA-Z0-9-_]+)/);
        if (idMatch && idMatch[1]) {
          return `https://docs.google.com/spreadsheets/d/${idMatch[1]}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheetName)}`;
        }

        const separator = config.includes('?') ? '&' : '?';
        return `${config}${separator}output=csv`;
      }

      return `https://docs.google.com/spreadsheets/d/${config}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheetName)}`;
    }

    async function loadData() {
      if (!REPLIES_SHEETS_CONFIG || !IMAGES_SHEETS_CONFIG) return;

      showLoading();

      try {
        const repliesUrl = buildSheetUrl(REPLIES_SHEETS_CONFIG, 'SavedReplies');
        const imagesUrl = buildSheetUrl(IMAGES_SHEETS_CONFIG, 'Images');
        console.log('üîó Fetching from:', repliesUrl, 'and', imagesUrl);
        const repliesResponse = await fetch(repliesUrl);
        const repliesCsv = await repliesResponse.text();
        allReplies = parseRepliesCSV(repliesCsv);

        const imagesResponse = await fetch(imagesUrl);
        const imagesCsv = await imagesResponse.text();
        allProducts = parseImagesCSV(imagesCsv);

        console.log('‚úÖ Loaded:', allReplies.length, 'replies,', Object.keys(allProducts).length, 'products');
        console.log(allProducts);

        renderCategories();
        filterReplies();

        document.getElementById('sync-text').textContent = 'Synced';
        setTimeout(() => {
          document.getElementById('sync-text').textContent = 'Live';
        }, 2000);

      } catch (error) {
        console.error('‚ùå Failed:', error);
        showError();
      }
    }

    function showLoading() {
      const tab = document.getElementById('replies-tab');
      tab.innerHTML = `
        <div class="loading">
          <div class="loading-spinner">‚ö°</div>
          <div class="empty-title">Loading...</div>
        </div>`;
    }

    function showError() {
      const tab = document.getElementById('replies-tab');
      tab.innerHTML = `
        <div class="empty-state">
          <div class="empty-icon">‚ö†Ô∏è</div>
          <div class="empty-title">Failed to load</div>
          <p>Check your configuration in settings</p>
        </div>`;
    }

    function switchTab(tab) {
      activeTab = tab;

      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));

      event.target.classList.add('active');
      document.getElementById(`${tab}-tab`).classList.add('active');

      const searchInput = document.getElementById('search-input');
      searchInput.placeholder = tab === 'replies' ? 'Search replies...' : 'Search products...';
      searchInput.value = '';

      if (tab === 'replies') {
        renderCategories();
        filterReplies();
      } else {
        document.getElementById('categories').style.display = 'none';
        renderImagesTab();
      }
    }

    // function parseRepliesCSV(csv) {
    //   const lines = csv.split('\n').filter(line => line.trim());
    //   const replies = [];
    //   console.log(lines);
    //   for (let i = 1; i < lines.length; i++) {
    //     const values = parseCSVLine(lines[i]);
    //     if (values.length < 2) continue;

    //     let imageUrl = values[3] || '';
    //     const match = imageUrl.match(/__(.+?)__/);
    //     if (match) imageUrl = match[1].trim();

    //     replies.push({
    //       title: values[0] || '',
    //       category: values[1] || 'General',
    //       description: values[2] || '',
    //       imageUrl: imageUrl
    //     });
    //   }

    //   return replies;
    // }
    function normalizeImageUrl(url) {
      const trimmed = (url || '').trim();
      if (!trimmed) return '';

      if (trimmed.startsWith('http://')) {
        return `https://${trimmed.slice(7)}`;
      }

      return trimmed;
    }
    function unwrapImageUrl(value) {
      if (!value) return '';
      value = value.trim();

      if (value.startsWith('__') && value.endsWith('__')) {
        return value.slice(2, -2);
      }

      return value;
    }

    function parseRepliesCSV(csv) {
      const rows = [];
      let current = '';
      let inQuotes = false;

      for (let i = 0; i < csv.length; i++) {
        const char = csv[i];
        const next = csv[i + 1];

        if (char === '"') {
          if (inQuotes && next === '"') {
            current += '"';
            i++;
          } else {
            inQuotes = !inQuotes;
          }
        }
        else if (char === '\n' && !inQuotes) {
          rows.push(current);
          current = '';
        }
        else {
          current += char;
        }
      }

      if (current) rows.push(current);

      const replies = [];

      for (let i = 1; i < rows.length; i++) {
        const values = parseCSVLine(rows[i]);
        if (values.length < 2) continue;

        let imageUrl = values[3] || '';
        // const match = imageUrl.match(/__(.+?)__/);
        // if (match) imageUrl = match[1].trim();
        imageUrl=unwrapImageUrl(imageUrl);
        imageUrl = normalizeImageUrl(imageUrl);

        replies.push({
          title: values[0] || '',
          category: values[1] || 'General',
          description: values[2] || '',
          imageUrl
        });
      }

      return replies;
    }


    function parseImagesCSV(csv) {
      const lines = csv.split('\n').filter(line => line.trim());
      const products = {};

      for (let i = 1; i < lines.length; i++) {
        const values = parseCSVLine(lines[i]);
        if (values.length < 2) continue;
        // console.log(values);
        const productName = values[0] || '';
        let imageUrls = values[1] || '';

        const urls = [];
        const regex = /__(.+?)__/g;
        let match;
        while ((match = regex.exec(imageUrls)) !== null) {
          urls.push(match[1].trim());
        }
        console.log('Extracted URLs for', productName, ':', urls);
        if (urls.length > 0) {
          products[productName] = urls;
        }
      }

      return products;
    }

    function parseCSVLine(line) {
      const result = [];
      let current = '';
      let inQuotes = false;

      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        const next = line[i + 1];

        if (char === '"') {
          if (inQuotes && next === '"') {
            current += '"';
            i++;
          } else {
            inQuotes = !inQuotes;
          }
        } else if (char === ',' && !inQuotes) {
          result.push(current);
          current = '';
        } else {
          current += char;
        }
      }
      result.push(current);

      return result.map(v => v.replace(/^"|"$/g, ''));
    }

    function renderCategories() {
      const categories = [...new Set(allReplies.map(r => r.category))].sort();
      const container = document.getElementById('categories');
      container.style.display = 'flex';

      container.innerHTML = `
        <div class="category-chip active" data-category="" onclick="selectCategory('')">All</div>
        ${categories.map(cat => `
          <div class="category-chip" data-category="${escapeHtml(cat)}" onclick="selectCategory('${escapeHtml(cat).replace(/'/g, "\\'")}')">${escapeHtml(cat)}</div>
        `).join('')}
      `;
    }

    function selectCategory(category) {
      activeCategory = category;

      document.querySelectorAll('.category-chip').forEach(chip => {
        chip.classList.toggle('active', chip.dataset.category === category);
      });

      filterReplies();
    }

    function handleSearch() {
      if (activeTab === 'replies') {
        filterReplies();
      } else {
        renderImagesTab();
      }
    }

    function filterReplies() {
      const query = document.getElementById('search-input').value.toLowerCase();

      filteredReplies = allReplies.filter(reply => {
        const matchesCategory = !activeCategory || reply.category === activeCategory;
        const matchesSearch = !query ||
          reply.title.toLowerCase().includes(query) ||
          reply.description.toLowerCase().includes(query);

        return matchesCategory && matchesSearch;
      });

      renderReplies();
    }

    function renderReplies() {
      const container = document.getElementById('replies-tab');

      if (filteredReplies.length === 0) {
        container.classList.remove('replies-grid');
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">üîç</div>
            <div class="empty-title">No replies found</div>
          </div>`;
        return;
      }

      container.classList.add('replies-grid');

      container.innerHTML = filteredReplies.map((reply, index) => `
        <div class="reply-card ${reply.imageUrl ? '' : 'no-image'}" onclick="copyReply(${index})">
          <div class="reply-main">
            <div class="reply-content">
              <div class="reply-header">
                <div class="reply-title">${escapeHtml(reply.title)}</div>
                <div class="copy-indicator">üìã</div>
              </div>
              <div class="reply-body">${escapeHtml(reply.description)}</div>
              <div class="reply-footer">
                <span class="category-tag">üè∑Ô∏è ${escapeHtml(reply.category)}</span>
              </div>
            </div>

            ${reply.imageUrl ? `
              <div class="reply-image-wrap">
                <img src="${normalizeImageUrl(reply.imageUrl)}" class="reply-image-preview" alt="${escapeHtml(reply.title)}" loading="lazy" />
              </div>
            ` : ''}
          </div>
        </div>
      `).join('');
    }

    async function copyReply(index) {
      const reply = filteredReplies[index];
      const description = reply.description || '';
      const imageUrl = normalizeImageUrl(reply.imageUrl);
      const canWriteRichClipboard = !!(window.ClipboardItem && navigator.clipboard?.write);

      if (!window.isSecureContext) {
        await navigator.clipboard.writeText(description);
        showToast('Copied text only (requires HTTPS for image copy)');
        return;
      }

      try {
        if (imageUrl && canWriteRichClipboard) {
          const response = await fetch(imageUrl, {
            mode: 'cors',
            credentials: 'omit',
            cache: 'no-store'
          });

          if (!response.ok) {
            throw new Error(`Image fetch failed (${response.status})`);
          }

          let imageBlob = await response.blob();
          if (!imageBlob.type || !imageBlob.type.startsWith('image/')) {
            throw new Error('URL did not return an image file');
          }

          if (ClipboardItem.supports && !ClipboardItem.supports(imageBlob.type)) {
            const bitmap = await createImageBitmap(imageBlob);
            const canvas = document.createElement('canvas');
            canvas.width = bitmap.width;
            canvas.height = bitmap.height;
            const ctx = canvas.getContext('2d');
            if (!ctx) throw new Error('Canvas unavailable for conversion');
            ctx.drawImage(bitmap, 0, 0);
            imageBlob = await new Promise((resolve, reject) => {
              canvas.toBlob((blob) => {
                if (blob) resolve(blob);
                else reject(new Error('PNG conversion failed'));
              }, 'image/png');
            });
          }

          const imageDataUrl = await new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = () => reject(new Error('Failed to build image data URL'));
            reader.readAsDataURL(imageBlob);
          });

          const textHtml = escapeHtml(description).replace(/\n/g, '<br>');
          const html = `<div><p style="margin:0 0 8px 0;">${textHtml}</p><img src="${imageDataUrl}" alt="image" /></div>`;
          const item = new ClipboardItem({
            'text/plain': new Blob([description], { type: 'text/plain' }),
            'text/html': new Blob([html], { type: 'text/html' })
          });

          await navigator.clipboard.write([item]);
          showToast('Copied text + image (paste into rich editor)');
          return;
        }

        await navigator.clipboard.writeText(description);
        showToast('Copied text');
      } catch (error) {
        await navigator.clipboard.writeText(description);
        const reason = (error && error.message) ? error.message : 'Image blocked by CORS or browser policy';
        showToast(`Copied text only: ${reason}`);
      }
    }


    function renderImagesTab() {
      const query = document.getElementById('search-input').value.toLowerCase();
      const container = document.getElementById('images-tab');

      const filteredProducts = Object.entries(allProducts).filter(([name, urls]) =>
        !query || name.toLowerCase().includes(query)
      );

      if (filteredProducts.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">üñºÔ∏è</div>
            <div class="empty-title">No products found</div>
          </div>`;
        return;
      }

      container.innerHTML = filteredProducts.map(([productName, imageUrls]) => `
        <div class="product-folder">
          <div class="product-folder-header">${escapeHtml(productName)}</div>
          <div class="images-grid">
            ${imageUrls.map(url => `
              <div class="image-item" onclick="openLightbox('${url}')">
                <img src="${url}" alt="${escapeHtml(productName)}" loading="lazy" />
              </div>
            `).join('')}
          </div>
        </div>
      `).join('');
    }

    function openLightbox(url) {
      document.getElementById('lightbox-image').src = url;
      document.getElementById('lightbox').classList.add('show');
    }

    function closeLightbox() {
      document.getElementById('lightbox').classList.remove('show');
    }

    function showToast(message) {
      const toast = document.getElementById('toast');
      document.getElementById('toast-text').textContent = message;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 2500);
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>

</body>

</html>